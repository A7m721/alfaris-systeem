<html dir="rtl" lang="ar">
<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <title> سوبر ماركت</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    rel="stylesheet"
  />
  <style>
    /* Custom scrollbar for product list */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #a3a3a3;
      border-radius: 3px;
    }
    /* Limit product grid height to show exactly 9 items (3 columns x 3 rows) */
    #productsGrid {
      max-height: calc(3 * (60px + 0.25rem + 0.25rem + 11px + 14px)); /* image height + padding + text approx */
      overflow-y: auto;
      scroll-behavior: smooth;
    }
    /* Print styles for thermal receipt */
    @media print {
      body * {
        visibility: hidden;
      }
      #printReceipt, #printReceipt * {
        visibility: visible;
      }
      #printReceipt {
        position: absolute;
        left: 0;
        top: 0;
        width: 80mm;
        font-family: monospace, monospace;
        font-size: 12px;
        direction: rtl;
        padding: 5mm;
      }
      #printReceipt table {
        width: 100%;
        border-collapse: collapse;
      }
      #printReceipt th, #printReceipt td {
        border-bottom: 1px dashed #000;
        padding: 2px 0;
        text-align: right;
      }
      #printReceipt th {
        font-weight: bold;
      }
      #printReceipt .center {
        text-align: center;
      }
      #printReceipt .bold {
        font-weight: bold;
      }
      #printReceipt hr {
        border: none;
        border-top: 1px dashed #000;
        margin: 5px 0;
      }
    }
  </style>
</head>
<body class="bg-[#f5f5f5] font-sans text-[13px] leading-tight">
  <div
    class="max-w-[900px] mx-auto mt-4 border border-gray-300 rounded-md bg-white shadow-sm relative"
  >
    <!-- Header -->
    <div
      class="flex items-center justify-between border-b border-gray-300 px-3 py-1.5 bg-[#f9f9f9] rounded-t-md"
    >
      <div class="flex items-center space-x-3 rtl:space-x-reverse">
        <button
          class="text-gray-600 hover:text-gray-800 text-[14px] flex items-center gap-1"
          type="button"
          onclick="alert('الذهاب إلى الصفحة الرئيسية')"
        >
          <i class="fas fa-home"></i>
          <span>الرئيسية</span>
        </button>
        <button
          class="text-gray-600 hover:text-gray-800 text-[14px] flex items-center gap-1"
          type="button"
          onclick="showInvoicesModal()"
        >
          <i class="fas fa-file-invoice"></i>
          <span>فاتورة البيع</span>
        </button>
      </div>
      <div class="flex items-center space-x-3 rtl:space-x-reverse">
        <button
          class="text-gray-600 hover:text-gray-800 text-[14px] flex items-center gap-1"
          type="button"
          onclick="openAddCustomProductModal()"
          title="إضافة منتج غير متاح"
        >
          <i class="fas fa-plus-circle"></i>
          <span>إضافة منتج غير متاح</span>
        </button>
      </div>
    </div>
    <div class="flex flex-col md:flex-row h-[600px]">
      <!-- Left side: Products -->
      <div class="w-full md:w-1/2 border-r border-gray-300 p-2 flex flex-col relative">
        <!-- Filters -->
        <div class="flex gap-2 mb-2">
          <select
            aria-label="All brands"
            id="brandFilter"
            class="flex-1 border border-gray-300 rounded px-2 py-1 text-[13px]"
            onchange="filterProducts()"
          >
            <option value="all">كل العلامات التجارية</option>
            <option value="brand1">ماركة 1</option>
            <option value="brand2">ماركة 2</option>
          </select>
          <select
            aria-label="All categories"
            id="categoryFilter"
            class="flex-1 border border-gray-300 rounded px-2 py-1 text-[13px]"
            onchange="filterProducts()"
          >
            <option value="all">كل الفئات</option>
            <option value="fruits">فواكه</option>
            <option value="vegetables">خضروات</option>
            <option value="dairy">ألبان</option>
            <option value="toys">ألعاب</option>
            <option value="beverages">مشروبات</option>
            <option value="household">منزلية</option>
          </select>
        </div>
        <!-- Products grid -->
        <div
          id="productsGrid"
          class="grid grid-cols-3 gap-1 scrollbar-thin border border-gray-300 rounded p-1 bg-[#d0e7a9] flex-1"
          style="min-height: 0;"
        >
          <!-- Products will be inserted here by JS -->
        </div>
      </div>
      <!-- Right side: Invoice -->
      <div class="w-full md:w-1/2 flex flex-col p-2">
        <!-- Top bar -->
        <div
          class="flex items-center justify-between mb-2 text-[13px] text-gray-700"
        >
          <div class="flex items-center space-x-2 rtl:space-x-reverse font-semibold text-blue-700">
            <span>فاتورة البيع</span>
            <i class="fas fa-file-invoice"></i>
          </div>
          <div class="flex items-center space-x-2 rtl:space-x-reverse">
            <button
              class="border border-gray-300 rounded px-2 py-0.5 text-[12px] hover:bg-gray-100"
              type="button"
              title="تحديث"
              onclick="resetInvoice()"
            >
              <i class="fas fa-sync-alt"></i>
            </button>
            <select
              aria-label="Walk-in customer"
              id="customerSelect"
              class="border border-gray-300 rounded px-2 py-0.5 text-[12px]"
              onchange="updateCustomer()"
            >
              <option value="walkin">زبون عابر</option>
              <option value="customer1">عميل 1</option>
              <option value="customer2">عميل 2</option>
            </select>
          </div>
        </div>
        <!-- Invoice table -->
        <div
          class="flex-1 border border-gray-300 rounded overflow-auto mb-2"
          style="min-height: 200px;"
        >
          <table
            id="invoiceTable"
            class="w-full text-[12px] text-center border-collapse"
          >
            <thead class="bg-blue-600 text-white">
              <tr>
                <th class="p-1 border border-blue-700">اسم المنتج</th>
                <th class="p-1 border border-blue-700">مكونات</th>
                <th class="p-1 border border-blue-700">الكمية</th>
                <th class="p-1 border border-blue-700">السعر</th>
                <th class="p-1 border border-blue-700">خصم</th>
                <th class="p-1 border border-blue-700">إجمالي</th>
                <th class="p-1 border border-blue-700">حذف</th>
              </tr>
            </thead>
            <tbody id="invoiceBody">
              <tr class="h-10">
                <td class="text-gray-500" colspan="7">لا توجد بيانات</td>
              </tr>
            </tbody>
          </table>
        </div>
        <!-- Bottom controls -->
        <div class="flex flex-col space-y-2">
          <input
            id="searchInput"
            class="border border-gray-300 rounded px-2 py-1 text-[13px]"
            placeholder="بحث"
            type="text"
            oninput="filterProducts()"
          />
          <div
            class="flex justify-between text-[13px] font-semibold"
            id="totals"
          >
            <div>المجموع الكلي: 0.00 ر.س</div>
            <div>إجمالي الخصم: 0.00 ر.س</div>
            <div>المبلغ الإجمالي: 0.00 ر.س</div>
            <div>الكمية: 0</div>
          </div>
          <div class="flex gap-2 flex-wrap">
            <button
              class="flex-1 bg-red-600 text-white rounded py-1 text-[13px] font-semibold hover:bg-red-700"
              type="button"
              onclick="cancelInvoice()"
            >
              إلغاء مؤقت
            </button>
            <button
              class="flex-1 bg-purple-700 text-white rounded py-1 text-[13px] font-semibold hover:bg-purple-800"
              type="button"
              onclick="completeSale()"
            >
              إتمام البيع
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <div
      class="border-t border-gray-300 text-center text-[12px] text-gray-500 py-1"
    >
      NULLBIT تم إنشاء نظام متكامل لتطوير متجر حديث متعدد القنوات 2023
    </div>

    <!-- Invoices Modal -->
    <div
      id="invoicesModal"
      class="fixed inset-0 hidden items-center justify-center z-50"
      aria-hidden="true"
    >
      <div
        class="modal-backdrop absolute inset-0"
        onclick="closeInvoicesModal()"
      ></div>
      <div
        class="bg-white rounded-lg shadow-lg max-w-3xl w-full max-h-[80vh] overflow-auto relative p-4"
      >
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">جميع الفواتير المسجلة</h2>
          <button
            class="text-gray-600 hover:text-gray-800 text-xl font-bold"
            aria-label="إغلاق"
            onclick="closeInvoicesModal()"
          >
            &times;
          </button>
        </div>
        <table class="w-full text-[13px] text-center border-collapse border border-gray-300">
          <thead class="bg-blue-600 text-white sticky top-0">
            <tr>
              <th class="border border-blue-700 p-2">رقم الفاتورة</th>
              <th class="border border-blue-700 p-2">تاريخ</th>
              <th class="border border-blue-700 p-2">اسم العميل</th>
              <th class="border border-blue-700 p-2">المجموع الكلي (ر.س)</th>
              <th class="border border-blue-700 p-2">إجمالي الخصم (ر.س)</th>
              <th class="border border-blue-700 p-2">المبلغ الإجمالي (ر.س)</th>
              <th class="border border-blue-700 p-2">الإجراءات</th>
            </tr>
          </thead>
          <tbody id="invoicesTableBody">
            <!-- Invoices will be rendered here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Add Custom Product Modal -->
    <div
      id="addCustomProductModal"
      class="fixed inset-0 hidden items-center justify-center z-50"
      aria-hidden="true"
    >
      <div
        class="modal-backdrop absolute inset-0 bg-black opacity-30"
        onclick="closeAddCustomProductModal()"
      ></div>
      <div
        class="bg-white rounded-lg shadow-lg max-w-md w-full p-6 relative z-10"
      >
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">إضافة منتج غير متاح</h2>
          <button
            class="text-gray-600 hover:text-gray-800 text-xl font-bold"
            aria-label="إغلاق"
            onclick="closeAddCustomProductModal()"
          >
            &times;
          </button>
        </div>
        <form id="customProductForm" onsubmit="submitCustomProduct(event)" class="space-y-4">
          <div>
            <label for="customProductName" class="block mb-1 font-semibold">اسم المنتج</label>
            <input
              type="text"
              id="customProductName"
              class="w-full border border-gray-300 rounded px-3 py-2 text-[13px]"
              required
              placeholder="أدخل اسم المنتج"
            />
          </div>
          <div>
            <label for="customProductComponents" class="block mb-1 font-semibold">المكونات</label>
            <input
              type="text"
              id="customProductComponents"
              class="w-full border border-gray-300 rounded px-3 py-2 text-[13px]"
              placeholder="أدخل مكونات المنتج"
            />
          </div>
          <div>
            <label for="customProductQuantity" class="block mb-1 font-semibold">الكمية</label>
            <input
              type="number"
              id="customProductQuantity"
              class="w-full border border-gray-300 rounded px-3 py-2 text-[13px]"
              min="1"
              value="1"
              required
            />
          </div>
          <div>
            <label for="customProductPrice" class="block mb-1 font-semibold">السعر (ر.س)</label>
            <input
              type="number"
              id="customProductPrice"
              class="w-full border border-gray-300 rounded px-3 py-2 text-[13px]"
              min="0"
              step="0.01"
              value="0.00"
              required
            />
          </div>
          <div>
            <label for="customProductDiscount" class="block mb-1 font-semibold">الخصم (ر.س)</label>
            <input
              type="number"
              id="customProductDiscount"
              class="w-full border border-gray-300 rounded px-3 py-2 text-[13px]"
              min="0"
              step="0.01"
              value="0.00"
              required
            />
          </div>
          <div class="flex justify-end gap-2">
            <button
              type="button"
              class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100 text-[13px]"
              onclick="closeAddCustomProductModal()"
            >
              إلغاء
            </button>
            <button
              type="submit"
              class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700 text-[13px]"
            >
              إضافة
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Hidden print receipt container -->
    <div id="printReceipt" class="hidden"></div>
  </div>

  <script>
    // Expanded products data for supermarket with more items
    const products = [
      // Fruits
      { id: 1, name: "تفاح أحمر", price: 5.5, discount: 0, components: "فاكهة", brand: "brand1", category: "fruits", img: "https://placehold.co/60x60/png?text=تفاح+أحمر" },
      { id: 2, name: "موز", price: 4.0, discount: 0, components: "فاكهة", brand: "brand2", category: "fruits", img: "https://placehold.co/60x60/png?text=موز" },
      { id: 13, name: "برتقال", price: 6.0, discount: 0, components: "فاكهة", brand: "brand1", category: "fruits", img: "https://placehold.co/60x60/png?text=برتقال" },
      { id: 14, name: "عنب", price: 7.0, discount: 0, components: "فاكهة", brand: "brand2", category: "fruits", img: "https://placehold.co/60x60/png?text=عنب" },
      { id: 15, name: "أناناس", price: 12.0, discount: 0, components: "فاكهة", brand: "brand1", category: "fruits", img: "https://placehold.co/60x60/png?text=أناناس" },
      { id: 16, name: "كيوي", price: 8.0, discount: 0, components: "فاكهة", brand: "brand2", category: "fruits", img: "https://placehold.co/60x60/png?text=كيوي" },
      // Vegetables
      { id: 5, name: "خيار", price: 3.0, discount: 0, components: "خضروات", brand: "brand1", category: "vegetables", img: "https://placehold.co/60x60/png?text=خيار" },
      { id: 6, name: "طماطم", price: 4.5, discount: 0, components: "خضروات", brand: "brand2", category: "vegetables", img: "https://placehold.co/60x60/png?text=طماطم" },
      { id: 17, name: "جزر", price: 3.5, discount: 0, components: "خضروات", brand: "brand1", category: "vegetables", img: "https://placehold.co/60x60/png?text=جزر" },
      { id: 18, name: "بطاطس", price: 2.5, discount: 0, components: "خضروات", brand: "brand2", category: "vegetables", img: "https://placehold.co/60x60/png?text=بطاطس" },
      { id: 19, name: "بصل", price: 3.0, discount: 0, components: "خضروات", brand: "brand1", category: "vegetables", img: "https://placehold.co/60x60/png?text=بصل" },
      // Dairy
      { id: 3, name: "حليب طازج", price: 7.5, discount: 0.5, components: "ألبان", brand: "brand1", category: "dairy", img: "https://placehold.co/60x60/png?text=حليب+طازج" },
      { id: 4, name: "جبنة شيدر", price: 15.0, discount: 1.0, components: "ألبان", brand: "brand2", category: "dairy", img: "https://placehold.co/60x60/png?text=جبنة+شيدر" },
      { id: 20, name: "زبادي", price: 6.0, discount: 0, components: "ألبان", brand: "brand1", category: "dairy", img: "https://placehold.co/60x60/png?text=زبادي" },
      { id: 21, name: "كريمة", price: 8.0, discount: 0, components: "ألبان", brand: "brand2", category: "dairy", img: "https://placehold.co/60x60/png?text=كريمة" },
      { id: 22, name: "زبدة", price: 10.0, discount: 0, components: "ألبان", brand: "brand1", category: "dairy", img: "https://placehold.co/60x60/png?text=زبدة" },
      // Toys
      { id: 11, name: "لعبة سيارة", price: 50.0, discount: 5.0, components: "ألعاب", brand: "brand1", category: "toys", img: "https://placehold.co/60x60/png?text=لعبة+سيارة" },
      { id: 12, name: "لعبة دمية", price: 45.0, discount: 0, components: "ألعاب", brand: "brand2", category: "toys", img: "https://placehold.co/60x60/png?text=لعبة+دمية" },
      { id: 23, name: "كرة قدم", price: 30.0, discount: 0, components: "ألعاب", brand: "brand1", category: "toys", img: "https://placehold.co/60x60/png?text=كرة+قدم" },
      { id: 24, name: "لعبة تركيب", price: 40.0, discount: 0, components: "ألعاب", brand: "brand2", category: "toys", img: "https://placehold.co/60x60/png?text=لعبة+تركيب" },
      { id: 25, name: "دمية محشوة", price: 35.0, discount: 0, components: "ألعاب", brand: "brand1", category: "toys", img: "https://placehold.co/60x60/png?text=دمية+محشوة" },
      // Beverages
      { id: 7, name: "عصير برتقال", price: 8.0, discount: 0, components: "مشروبات", brand: "brand1", category: "beverages", img: "https://placehold.co/60x60/png?text=عصير+برتقال" },
      { id: 8, name: "مياه معدنية", price: 2.0, discount: 0, components: "مشروبات", brand: "brand2", category: "beverages", img: "https://placehold.co/60x60/png?text=مياه+معدنية" },
      { id: 26, name: "شاي", price: 5.0, discount: 0, components: "مشروبات", brand: "brand1", category: "beverages", img: "https://placehold.co/60x60/png?text=شاي" },
      { id: 27, name: "قهوة", price: 10.0, discount: 0, components: "مشروبات", brand: "brand2", category: "beverages", img: "https://placehold.co/60x60/png?text=قهوة" },
      { id: 28, name: "مشروب غازي", price: 6.0, discount: 0, components: "مشروبات", brand: "brand1", category: "beverages", img: "https://placehold.co/60x60/png?text=مشروب+غازي" },
      // Household
      { id: 9, name: "منظف أرضيات", price: 20.0, discount: 2.0, components: "منزلية", brand: "brand1", category: "household", img: "https://placehold.co/60x60/png?text=منظف+أرضيات" },
      { id: 10, name: "مناديل ورقية", price: 10.0, discount: 0, components: "منزلية", brand: "brand2", category: "household", img: "https://placehold.co/60x60/png?text=مناديل+ورقية" },
      { id: 29, name: "صابون غسيل", price: 15.0, discount: 0, components: "منزلية", brand: "brand1", category: "household", img: "https://placehold.co/60x60/png?text=صابون+غسيل" },
      { id: 30, name: "منظف زجاج", price: 12.0, discount: 0, components: "منزلية", brand: "brand2", category: "household", img: "https://placehold.co/60x60/png?text=منظف+زجاج" },
      { id: 31, name: "معطر جو", price: 18.0, discount: 0, components: "منزلية", brand: "brand1", category: "household", img: "https://placehold.co/60x60/png?text=معطر+جو" },
    ];

    let invoiceItems = [];
    const STORAGE_KEY = "supermarket_invoices";
    const INVOICE_STORAGE_KEY = "supermarket_current_invoice";
    const CUSTOMER_STORAGE_KEY = "supermarket_current_customer";
    const BRAND_FILTER_STORAGE_KEY = "supermarket_brand_filter";
    const CATEGORY_FILTER_STORAGE_KEY = "supermarket_category_filter";
    const SEARCH_STORAGE_KEY = "supermarket_search";

    // Render products grid based on filters and search
    function renderProducts() {
      const grid = document.getElementById("productsGrid");
      grid.innerHTML = "";
      const brandFilter = document.getElementById("brandFilter").value;
      const categoryFilter = document.getElementById("categoryFilter").value;
      const searchTerm = document
        .getElementById("searchInput")
        .value.trim()
        .toLowerCase();

      const filtered = products.filter((p) => {
        const matchesBrand = brandFilter === "all" || p.brand === brandFilter;
        const matchesCategory =
          categoryFilter === "all" || p.category === categoryFilter;
        const matchesSearch =
          p.name.toLowerCase().includes(searchTerm) ||
          p.components.toLowerCase().includes(searchTerm);
        return matchesBrand && matchesCategory && matchesSearch;
      });

      if (filtered.length === 0) {
        grid.innerHTML =
          '<div class="col-span-3 text-center text-gray-600 mt-4">لا توجد منتجات</div>';
        return;
      }

      filtered.forEach((p) => {
        const div = document.createElement("div");
        div.className =
          "bg-[#b4d66a] border border-[#a3c75a] rounded p-1 text-center text-[11px] font-semibold cursor-pointer hover:bg-[#a3c75a]";
        div.title = `السعر: ${p.price.toFixed(2)} ر.س\nالخصم: ${p.discount.toFixed(
          2
        )} ر.س\nالمكونات: ${p.components}`;
        div.innerHTML = `
          <img src="${p.img}" alt="صورة ${p.name}" class="mx-auto mb-1" width="60" height="60" />
          <div>${p.price.toFixed(2)} ر.س</div>
          <div>${p.name}</div>
        `;
        div.onclick = () => addToInvoice(p.id);
        grid.appendChild(div);
      });
    }

    // Add product to invoice or increase quantity if exists
    function addToInvoice(productId) {
      const product = products.find((p) => p.id === productId);
      if (!product) return;

      const existing = invoiceItems.find((item) => item.id === productId);
      if (existing) {
        existing.quantity++;
      } else {
        invoiceItems.push({
          ...product,
          quantity: 1,
        });
      }
      renderInvoice();
      saveCurrentInvoice();
    }

    // Render invoice table
    function renderInvoice() {
      const tbody = document.getElementById("invoiceBody");
      tbody.innerHTML = "";
      if (invoiceItems.length === 0) {
        tbody.innerHTML =
          '<tr class="h-10"><td class="text-gray-500" colspan="7">لا توجد بيانات</td></tr>';
        updateTotals();
        return;
      }

      invoiceItems.forEach((item, index) => {
        const totalPrice = (item.price - item.discount) * item.quantity;
        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-200";
        tr.innerHTML = `
          <td class="p-1 border border-blue-700">${item.name}</td>
          <td class="p-1 border border-blue-700">${item.components}</td>
          <td class="p-1 border border-blue-700">
            <input type="number" min="1" value="${item.quantity}" class="w-16 text-center border border-gray-300 rounded" onchange="updateQuantity(${index}, this.value)" />
          </td>
          <td class="p-1 border border-blue-700">
            <input type="number" min="0" step="0.01" value="${item.price.toFixed(2)}" class="w-20 text-center border border-gray-300 rounded" onchange="updatePrice(${index}, this.value)" />
          </td>
          <td class="p-1 border border-blue-700">
            <input type="number" min="0" step="0.01" value="${item.discount.toFixed(2)}" class="w-20 text-center border border-gray-300 rounded" onchange="updateDiscount(${index}, this.value)" />
          </td>
          <td class="p-1 border border-blue-700">${totalPrice.toFixed(2)}</td>
          <td class="p-1 border border-blue-700">
            <button class="text-red-600 hover:text-red-800" onclick="removeItem(${index})" title="حذف">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      updateTotals();
      saveCurrentInvoice();
    }

    // Update quantity of an item in invoice
    function updateQuantity(index, value) {
      const qty = parseInt(value);
      if (isNaN(qty) || qty < 1) {
        alert("الكمية يجب أن تكون رقم صحيح أكبر من 0");
        renderInvoice();
        return;
      }
      invoiceItems[index].quantity = qty;
      renderInvoice();
    }

    // Update price of an item in invoice
    function updatePrice(index, value) {
      const price = parseFloat(value);
      if (isNaN(price) || price < 0) {
        alert("السعر يجب أن يكون رقم أكبر من أو يساوي 0");
        renderInvoice();
        return;
      }
      if (invoiceItems[index].discount > price) {
        alert("الخصم لا يمكن أن يكون أكبر من السعر");
        renderInvoice();
        return;
      }
      invoiceItems[index].price = price;
      renderInvoice();
    }

    // Update discount of an item in invoice
    function updateDiscount(index, value) {
      const discount = parseFloat(value);
      if (isNaN(discount) || discount < 0) {
        alert("الخصم يجب أن يكون رقم أكبر من أو يساوي 0");
        renderInvoice();
        return;
      }
      if (discount > invoiceItems[index].price) {
        alert("الخصم لا يمكن أن يكون أكبر من السعر");
        renderInvoice();
        return;
      }
      invoiceItems[index].discount = discount;
      renderInvoice();
    }

    // Remove item from invoice
    function removeItem(index) {
      invoiceItems.splice(index, 1);
      renderInvoice();
    }

    // Update totals display
    function updateTotals() {
      const totalsDiv = document.getElementById("totals");
      let totalPrice = 0;
      let totalDiscount = 0;
      let totalQuantity = 0;

      invoiceItems.forEach((item) => {
        totalPrice += item.price * item.quantity;
        totalDiscount += item.discount * item.quantity;
        totalQuantity += item.quantity;
      });

      const finalTotal = totalPrice - totalDiscount;

      totalsDiv.innerHTML = `
        <div>المجموع الكلي: ${totalPrice.toFixed(2)} ر.س</div>
        <div>إجمالي الخصم: ${totalDiscount.toFixed(2)} ر.س</div>
        <div>المبلغ الإجمالي: ${finalTotal.toFixed(2)} ر.س</div>
        <div>الكمية: ${totalQuantity}</div>
      `;
    }

    // Filter products on filters or search change
    function filterProducts() {
      renderProducts();
      saveFiltersAndSearch();
    }

    // Reset invoice
    function resetInvoice() {
      if (confirm("هل تريد إلغاء الفاتورة الحالية؟")) {
        invoiceItems = [];
        renderInvoice();
        saveCurrentInvoice();
      }
    }

    // Cancel invoice (temporary cancel)
    function cancelInvoice() {
      if (confirm("هل تريد إلغاء الفاتورة مؤقتاً؟")) {
        invoiceItems = [];
        renderInvoice();
        saveCurrentInvoice();
        alert("تم إلغاء الفاتورة مؤقتاً");
      }
    }

    // Complete sale with thermal receipt print
    function completeSale() {
      if (invoiceItems.length === 0) {
        alert("لا توجد منتجات لإتمام البيع");
        return;
      }
      saveInvoice();
      printThermalReceipt();
      invoiceItems = [];
      renderInvoice();
      saveCurrentInvoice();
      alert("تم إتمام البيع بنجاح");
    }

    // Update customer selection (just alert for demo)
    function updateCustomer() {
      const customer = document.getElementById("customerSelect").value;
      alert(`تم اختيار العميل: ${customer === "walkin" ? "زبون عابر" : customer}`);
      saveCurrentCustomer();
    }

    // Save current invoice to localStorage (completed invoices)
    function saveInvoice() {
      const invoices = getInvoices();
      const now = new Date();
      const invoiceNumber = invoices.length + 1;
      let totalPrice = 0;
      let totalDiscount = 0;
      let totalQuantity = 0;
      invoiceItems.forEach((item) => {
        totalPrice += item.price * item.quantity;
        totalDiscount += item.discount * item.quantity;
        totalQuantity += item.quantity;
      });
      const finalTotal = totalPrice - totalDiscount;

      const invoiceData = {
        id: invoiceNumber,
        date: now.toLocaleString("ar-EG", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
        }),
        customer:
          document.getElementById("customerSelect").value === "walkin"
            ? "زبون عابر"
            : document.getElementById("customerSelect").value,
        items: JSON.parse(JSON.stringify(invoiceItems)),
        totalPrice: totalPrice.toFixed(2),
        totalDiscount: totalDiscount.toFixed(2),
        finalTotal: finalTotal.toFixed(2),
        totalQuantity,
      };
      invoices.push(invoiceData);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
    }

    // Get invoices from localStorage
    function getInvoices() {
      const invoices = localStorage.getItem(STORAGE_KEY);
      return invoices ? JSON.parse(invoices) : [];
    }

    // Show invoices modal
    function showInvoicesModal() {
      const modal = document.getElementById("invoicesModal");
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      renderInvoicesTable();
    }

    // Close invoices modal
    function closeInvoicesModal() {
      const modal = document.getElementById("invoicesModal");
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    // Render invoices table in modal
    function renderInvoicesTable() {
      const tbody = document.getElementById("invoicesTableBody");
      const invoices = getInvoices();
      tbody.innerHTML = "";
      if (invoices.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="7" class="text-gray-600 p-4">لا توجد فواتير مسجلة</td></tr>';
        return;
      }
      invoices.forEach((inv) => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-200 hover:bg-gray-100 cursor-pointer";
        tr.title = "انقر لعرض تفاصيل الفاتورة";
        tr.innerHTML = `
          <td class="border border-blue-700 p-2">${inv.id}</td>
          <td class="border border-blue-700 p-2">${inv.date}</td>
          <td class="border border-blue-700 p-2">${inv.customer}</td>
          <td class="border border-blue-700 p-2">${inv.totalPrice}</td>
          <td class="border border-blue-700 p-2">${inv.totalDiscount}</td>
          <td class="border border-blue-700 p-2">${inv.finalTotal}</td>
          <td class="border border-blue-700 p-2">
            <button class="text-blue-600 hover:text-blue-800" onclick="viewInvoiceDetails(${inv.id})" title="عرض التفاصيل">
              <i class="fas fa-eye"></i>
            </button>
            <button class="text-red-600 hover:text-red-800 ml-2" onclick="deleteInvoice(${inv.id})" title="حذف الفاتورة">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // View invoice details (alert with items)
    function viewInvoiceDetails(id) {
      const invoices = getInvoices();
      const invoice = invoices.find((inv) => inv.id === id);
      if (!invoice) {
        alert("الفاتورة غير موجودة");
        return;
      }
      let details = `تفاصيل الفاتورة رقم ${invoice.id}:\n\n`;
      invoice.items.forEach((item, idx) => {
        details += `${idx + 1}. ${item.name} - الكمية: ${item.quantity} - السعر: ${item.price.toFixed(
          2
        )} ر.س - الخصم: ${item.discount.toFixed(2)} ر.س\n`;
      });
      details += `\nالمجموع الكلي: ${invoice.totalPrice} ر.س\nإجمالي الخصم: ${invoice.totalDiscount} ر.س\nالمبلغ الإجمالي: ${invoice.finalTotal} ر.س\nالكمية الكلية: ${invoice.totalQuantity}`;
      alert(details);
    }

    // Delete invoice by id
    function deleteInvoice(id) {
      if (!confirm("هل أنت متأكد من حذف هذه الفاتورة؟")) return;
      let invoices = getInvoices();
      invoices = invoices.filter((inv) => inv.id !== id);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(invoices));
      renderInvoicesTable();
    }

    // Print thermal receipt
    function printThermalReceipt() {
      const receiptDiv = document.getElementById("printReceipt");
      const now = new Date();
      let totalPrice = 0;
      let totalDiscount = 0;
      let totalQuantity = 0;
      invoiceItems.forEach(item => {
        totalPrice += item.price * item.quantity;
        totalDiscount += item.discount * item.quantity;
        totalQuantity += item.quantity;
      });
      const finalTotal = totalPrice - totalDiscount;
      const customer = document.getElementById("customerSelect").value === "walkin" ? "زبون عابر" : document.getElementById("customerSelect").value;

      let html = `
        <div class="center bold">سوبر ماركت</div>
        <div class="center">فاتورة بيع حرارية</div>
        <div class="center">${now.toLocaleString("ar-EG")}</div>
        <hr />
        <div>رقم الفاتورة: <span class="bold">${getInvoices().length}</span></div>
        <div>العميل: <span class="bold">${customer}</span></div>
        <hr />
        <table>
          <thead>
            <tr>
              <th>المنتج</th>
              <th>الكمية</th>
              <th>السعر</th>
              <th>الإجمالي</th>
            </tr>
          </thead>
          <tbody>
      `;

      invoiceItems.forEach(item => {
        const itemTotal = (item.price - item.discount) * item.quantity;
        html += `
          <tr>
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${item.price.toFixed(2)}</td>
            <td>${itemTotal.toFixed(2)}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
        <hr />
        <div>المجموع الكلي: <span class="bold">${totalPrice.toFixed(2)} ر.س</span></div>
        <div>إجمالي الخصم: <span class="bold">${totalDiscount.toFixed(2)} ر.س</span></div>
        <div>المبلغ الإجمالي: <span class="bold">${finalTotal.toFixed(2)} ر.س</span></div>
        <div>الكمية الكلية: <span class="bold">${totalQuantity}</span></div>
        <hr />
        <div class="center">شكراً لتسوقكم معنا</div>
      `;

      receiptDiv.innerHTML = html;
      receiptDiv.classList.remove("hidden");

      setTimeout(() => {
        window.print();
        receiptDiv.classList.add("hidden");
      }, 100);
    }

    // Open Add Custom Product Modal
    function openAddCustomProductModal() {
      document.getElementById("addCustomProductModal").classList.remove("hidden");
      document.getElementById("addCustomProductModal").classList.add("flex");
      // Reset form fields
      document.getElementById("customProductForm").reset();
      document.getElementById("customProductQuantity").value = 1;
      document.getElementById("customProductPrice").value = "0.00";
      document.getElementById("customProductDiscount").value = "0.00";
    }

    // Close Add Custom Product Modal
    function closeAddCustomProductModal() {
      document.getElementById("addCustomProductModal").classList.add("hidden");
      document.getElementById("addCustomProductModal").classList.remove("flex");
    }

    // Submit custom product form
    function submitCustomProduct(event) {
      event.preventDefault();
      const name = document.getElementById("customProductName").value.trim();
      const components = document.getElementById("customProductComponents").value.trim() || "-";
      const quantity = parseInt(document.getElementById("customProductQuantity").value);
      const price = parseFloat(document.getElementById("customProductPrice").value);
      const discount = parseFloat(document.getElementById("customProductDiscount").value);

      if (!name) {
        alert("يرجى إدخال اسم المنتج");
        return;
      }
      if (isNaN(quantity) || quantity < 1) {
        alert("الكمية يجب أن تكون رقم صحيح أكبر من 0");
        return;
      }
      if (isNaN(price) || price < 0) {
        alert("السعر يجب أن يكون رقم صحيح أو عشري أكبر من أو يساوي 0");
        return;
      }
      if (isNaN(discount) || discount < 0) {
        alert("الخصم يجب أن يكون رقم صحيح أو عشري أكبر من أو يساوي 0");
        return;
      }
      if (discount > price) {
        alert("الخصم لا يمكن أن يكون أكبر من السعر");
        return;
      }

      // Create a unique id for custom product (negative to avoid conflict)
      const customId = Date.now() * -1;

      // Add custom product to invoiceItems
      invoiceItems.push({
        id: customId,
        name,
        components,
        quantity,
        price,
        discount,
        brand: "custom",
        category: "custom",
        img: "https://placehold.co/60x60/png?text=منتج+غير+متاح",
      });

      renderInvoice();
      closeAddCustomProductModal();
    }

    // Save current invoice to localStorage (draft)
    function saveCurrentInvoice() {
      localStorage.setItem(INVOICE_STORAGE_KEY, JSON.stringify(invoiceItems));
    }

    // Load current invoice from localStorage (draft)
    function loadCurrentInvoice() {
      const saved = localStorage.getItem(INVOICE_STORAGE_KEY);
      if (saved) {
        try {
          invoiceItems = JSON.parse(saved);
        } catch {
          invoiceItems = [];
        }
      } else {
        invoiceItems = [];
      }
    }

    // Save current customer selection
    function saveCurrentCustomer() {
      const customer = document.getElementById("customerSelect").value;
      localStorage.setItem(CUSTOMER_STORAGE_KEY, customer);
    }

    // Load current customer selection
    function loadCurrentCustomer() {
      const saved = localStorage.getItem(CUSTOMER_STORAGE_KEY);
      if (saved) {
        const select = document.getElementById("customerSelect");
        if ([...select.options].some(o => o.value === saved)) {
          select.value = saved;
        } else {
          select.value = "walkin";
        }
      }
    }

    // Save filters and search inputs
    function saveFiltersAndSearch() {
      localStorage.setItem(BRAND_FILTER_STORAGE_KEY, document.getElementById("brandFilter").value);
      localStorage.setItem(CATEGORY_FILTER_STORAGE_KEY, document.getElementById("categoryFilter").value);
      localStorage.setItem(SEARCH_STORAGE_KEY, document.getElementById("searchInput").value);
    }

    // Load filters and search inputs
    function loadFiltersAndSearch() {
      const brand = localStorage.getItem(BRAND_FILTER_STORAGE_KEY);
      const category = localStorage.getItem(CATEGORY_FILTER_STORAGE_KEY);
      const search = localStorage.getItem(SEARCH_STORAGE_KEY);

      if (brand) document.getElementById("brandFilter").value = brand;
      if (category) document.getElementById("categoryFilter").value = category;
      if (search) document.getElementById("searchInput").value = search;
    }

    // On page load, restore saved data
    window.addEventListener("load", () => {
      loadFiltersAndSearch();
      loadCurrentCustomer();
      loadCurrentInvoice();
      renderProducts();
      renderInvoice();
    });

    // Save current invoice and filters before unload
    window.addEventListener("beforeunload", () => {
      saveCurrentInvoice();
      saveCurrentCustomer();
      saveFiltersAndSearch();
    });
  </script>
</body>
</html>
